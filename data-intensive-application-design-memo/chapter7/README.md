## トランザクション

### トランザクションというとらえどころのない概念

- Introduction
  - ほぼ全ての RDB に存在するものの、レプリケーションとパーティショニングとの相性が悪い。
    - それぞれのテーブルに分割されるからねえ。
  - そのため、トランザクションは確実ではなく、メリットと限界がある。
  - トレードオフを理解して設計する必要がある。
- ACID
  - Atomicity, Consistency, Isolation, Durability
  - Isolation は分離性だが、詳細では複数の意味を持つ
  - Atomicity
    - トランザクションが中断するか完了するかで状態が一意に決まること
  - Consistency
    - 不変性の下でも適切な状態を保つこと
  - Isolation
    - クライアントごとの分離のこと
  - Durability
    - 永続化のこと

### 弱い分離レベル

- Read Commited
  - データベースからの読み取りを行なった際に見えるデータはコミットされたものであること
  - データベースの書き込みを行う際、上書きするのはコミットされたデータのみであること
  - この二つで dirty read を防ぐ。
- スナップショット分離（Repeatable Read）
  - read commited だけでは並行されて叩かれる場合の一貫性がない場合がある。
  - データベースの書き込みを行う際、上書きするのはコミットされたデータのみであること
  - データベースから読み取りを行う際に、コミット前のデータを閲覧することを許容する。
  - dirty write を防ぐ
- 更新ロストの回避方法
  - システム側がアトミックな書き込み操作にするべく、カーソル固定という読み取りの際には排他ロックを取る
  - クライアントが明示的なロックを取得
  - 自動的にロストを検出する。
  - レプリケーションを（シャーディング）を採用している場合では、完全に防ぐことができず、LLW 処理が必要
- 書き込みスキューとファントム
  - 複数の条件に前提があるが複数の行を更新する場合は、条件が消えてしまう場合がある（書き込みスキュー）
    - ダブルブッキングなど
  - この問題の本質は、行ロックをかける対象が存在しないこと
  - FK などの指定が必要だが、複数行に対する場合は procedure で制約を加えるしかないかも
  - ロックのかけるために、別のテーブルを作ったりする（衝突の実体化）
- 直接化可能性
  - 直列化分離レベルが一番強い分離レベルで、最も安全ではある。
  - 手法としては
    - 順次実行
    - Two-Phase Lock
    - 直列化可能なスナップショット分離
  - 完全な順次実行
    - 並行性の問題を解決するために並行性を完全に排除する
      - シングルスレッドの性能を最大に発揮できるようにシステム側が調整しているものもある
    - use case としては
      - トランザクションが小さくて高速であること
      - active なデータセットがメモリにのる場合。
      - 書き込みスループットが単一 CPU が処理できるほど十分に低いこと
      - パーティーションにまたがるトランザクションも実行できるがそのハードリミットが儲けられる場合
        - 相当この処理が遅いため
