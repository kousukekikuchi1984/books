## 分散システムの問題点

### フォールトと部分障害

- 特徴
  - 部分障害
    - ある部分は問題なく動作しているが、何らかの形で破損していることがある
  - 非決定的
    - 確率的にうまくいくのとうまく行かない
- 構築方法
  - クラウドコンピューティング
    - 部分障害の可能性を受け入れ、ソフトウェアに fault torelance を組み込む
    - シェアードナッシングシステム（非同期パケットネットワークでノードを接続する）
  - スーパーコンピューティング
    - 適宜チェックポイントを作成し、データを永続化する。
    - 障害はそのノードをクラスタから外す
    - 別のノードがチェックポイントから再開する
    - いわば、システムの一部に障害があるノードはクラッシュさせて外している

### 信頼性の低いネットワーク

- シェアードナッシングシステムがクラウドコンピューティングの大半
- 非同期パケットネットワークはパケットが対象ノードから反応がない場合、タイムアウトで検知する。
- その場合はロードバランサのローテーションから外したり、別のフォロワーをリーダーに昇格させる。

### 信頼性の低いクロック

- クロック
  - 時刻クロック
    - 時間の計測のために使われるクロック
    - NTP に同期する必要
  - 単調増加クロック
    - 期間計測に用いられるクロック
    - NTP と同期する必要がない
- クロックの正確性
  - マシン内の温度によって CPU の振動数が変化する
  - NTP との同期がネットワークの輻輳により遅延する
  - NTP のクロック自体が変動する
  - 閏秒の時には確実にズレる。この場合は、1 日かけて調整する
  - 精度を出すには GPS と PTP 注意深いモニタリングで実現可能らしいけど、GPS はなんで？
  - 信頼区間は 100ms くらいまでみておく必要がある
- 同期クロック
  - 順序関係を持つイベントのタイムスタンプの時にズレる可能性がある。

### 真実は多数決で決定される

- 分散システムの障害例
  - 有効なロックが実は処理の遅延のための解除されていたために競合が発生
    - lock 時にロック番号を発行して、最新のもののみ受け付けるで回避可能
    - facing token
    - ZooKeeper
  - ノードがレスポンスを返してくれるかわからない状態である
    - ビザンチン将軍問題
- システムモデル
  - とは？
    - システム中で生じると予測されるフォールトの種類を定式化する必要がる。
    - そのためのアルゴリズムが前提としていることを抽象化して記述したもの
  - 同期モデル
    - ネットワークの遅延、一時停止、クロックの変動が一定の上限を超えないとわかっている。
    - 実際は現実的なモデルではない。
  - 部分同期モデル
    - 時々ネットワークの遅延、一時停止、クロックの変動が上限を超えることがある。
    - 現実的なモデル。
  - 非同期モデル
    - タイミングに関していかなる前提を持つことを許されない
- ノード障害
  - クラッシュストップフォールト
    - ノードの障害はクラッシュしかなく、クラスタへの復帰はされない
  - クラッシュリカバリフォールト
    - クラッシュ後にレスポンスは再び戻すが、メモリのデータは保持されない
  - ビザンチン（任意）障害
    - ノードが誤った情報を送る可能性
