## 一貫性と合意

### 一貫性の保証

- 分散処理における一貫性とは結果整合性のことをさす
  - シングルスレッドプログラムとは振る舞いがあまりにも違うらしい。
    - 書き込みの後にすぐに読み込みしたら、古いデータが帰ってくる可能性など
    - 衝突とかもそう
  - この辺りはトランザクション分離レベルと同じような点がある

### 線形化可能性

- とは
  - 原子的一貫性、強い一貫性、即時一貫性、外部一貫性と呼ばれる
  - データのコピーが一つしかなく、その操作もアトミックであること。
  - 最新性の保証と言える
- 具体例
  - クライアントの処理中に別のクライアントがその値（レジスタ）を呼び出そうとした時
    - 過去と同じ値が帰ってきたら更新されていないので、線形化可能性
    - 同じ値が帰ってこなかったら更新されているので、線形化可能性ではない
- 制約や特徴
  - split brain を避けるために、リーダーは確実に一つに選出されなければいけない
  - Unique key を保証したいなら、線形化可能性が求められる
- 線形化可能なシステム
  - シングルリーダーレプリケーション
  - 合意アルゴリズム
  - マルチリーダーレプリケーションは無理
  - リーダーレスレプリケーションはおそらく線形可能化ではない

### 順序の保証

- 順序づけが因果関係を保つので、確実に決まるように定めなければならない。
- そして、線形化可能性には操作には全順序である必要がある。
  - タイムスタンプ（信頼性はアレですが）
  - シークエンス番号
  - 全順序ブロードキャスト（ZooKeeper）

### 分散トランザクションと合意

- リーダの選出
- アトミックなコミット（Two-phase Commit）
  - 複数のノードがトランザクションに関わっていた時にはあるノードだけ commit がなされ、別のノードが rollback したら困る
  - prepare -> commit
  - 実際分散トランザクションを使うクラウドサービスは少ない
  - 欠点
    - トランザクションが 10 倍時間かかる
    - coordinator が prepare と commit の間に途中で消失した場合はトランザクションが終了しないので、管理者が手作業で問題を解決する必要がある
- exactly-once なメッセージ処理
  - メッセージブローカーが失敗またはデータベーストランザクションが失敗したら rollback したい。
  - message queue を用いる場合は、event 処理前に承認を commit する。
  - その commit がないものは event 処理を行わない
- XA トランザクション
  - hetrogenious な技術間での Two-phase Commit の標準
  - Message Broker でサポートされている。
- 未確定状態中のロック保持
  - コーディネーターに障害がある時には、解消されるまでロックが保持される。
- コーディネーター障害からのリカバリ
  - 何らかの原因でコーディネータがトランザクションの結果を判断できないものが発生する可能性がある
  - その場合に orphaned なトランザクションは残り続ける。
  - その時には管理者が手作業でコミットがロールバックかを判断する必要がある。

### 耐障害性を持つ合意

- 一つ以上のノードが値を提案し、合意アルゴリズムはそれらの値の中から一つを決定する
- 合意アルゴリズムと全順序ブロードキャスト
  - 値の並びに対して決定を行う
  - メッセージを厳密に一度だけ同じ順序で全てのノードに配信する。
- シングルリーダーレプリケーションと合意
  - リーダー障害時にリーダー選出とファイルオーバーを行う。
  - この際に、全ノードが新リーダーが誰であるか合意する必要がある。
- エポック番号とクオラム
  - こまかいので割愛。
  - リーダー選出の細かい手続きに関して書かれいる。
- 合意の限界
  - 多数決に必要なノード数をみてしていること。具体的には 3 ノード以上でなければいけない。
  - 障害発生の検出は別ノードからのタイムアウトに依存している。

### メンバーシップと協調サービス

- Zookeeper や etcd
  - 分散キーバリューストア
  - つまり、一つのノードに対して変更したことが他のノードにも変更できる。
  - しかしながらそのことを利用して、全てのノードでロックをかけたり、障害検出をしたりすることが可能。
- ノードへの処理の割り当て
  - リーダーの選出
  - partitioning されたリソースに対して、割り当ての判断
  - atomic な処理
- サービスディスカバリ
  - 特定なサービスにアクセスするために接続しなければならない IP アドレスを知る。
    - DNS をかつては使われてきたが、線形可能性ではなく、読み取り結果のタムラグが発生する。
- メンバーシップサービス
  - 全てのノードのデータから、どのノードが死活を判断できる。
